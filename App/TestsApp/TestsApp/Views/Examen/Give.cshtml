@model TestsApp.Models.Examen

@{
    ViewBag.Title = "Give";
}

@Scripts.Render("~/bundles/countdown")

<div class="box-header">
    <i class="icon-th-list"></i>Dar Examen 
</div>
<input type="hidden" id="hdn-Minutos" value="@Model.TiempoMaximo.Minutes" />
<input type="hidden" id="hdn-Segundos" value="@Model.TiempoMaximo.Seconds" />
<input type="hidden" id="hdn-FechaInicioEjecucion" value="@Model.FechaEjecucion.ToString("yyyy,MM,dd,H,mm,ss")" />

<div class="row-fluid">
    <div class="span10 center-div">
        <div class="padded">
            <div class="row-fluid">
                <div class="span6">
                    <div class="input full-width">
                        <h1>
                            @Model.Titulo
                        </h1>
                    </div>
                    <div class="input full-width">
                        <h4>Línea: @Model.Linea.Nombre
                        </h4>
                    </div>
                </div>
                <div class="span6">
                    <div class="row-fluid input full-width">
                        <div class="span3">
                            Tiempo Restante:
                        </div>
                        <div class="span4">
                            <div id="tiempoRestante">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-title"></div>
            <div class="row-fluid" id="PreguntasRow">
                <div class="span3" id="loading-div">
                    <div class="well well-large well-transparent lead centered">
                        <i class="icon-spinner icon-spin icon-2x pull-left"></i>Guardando...
                    </div>
                </div>
                @using (Html.BeginForm("Give", "Examen", FormMethod.Post, new { name = "frmPreguntas", id = "frmPreguntas" }))
                {
                    @Html.HiddenFor(m => m.TiempoTranscurrido, new { id = "hdn-TiempoTranscurrido" })
                    <div id="PreguntasContainer">
                        @Html.Partial("GivePreguntaPartial", Model.Pregunta.ElementAt(0))
                    </div>
                    
                }
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    function startingAjax() {
        //$('#loading-div').css("left", 100);
        //$('#loading-div').css("top", 5);
        var divWidth = $("#loading-div").width();
        $("#loading-div").css({ "margin-left": -divWidth / 2, "top": "50%", "left": "50%" });
        $('#loading-div').show();
    }
    function ajaxCompleted() {
        $('#loading-div').hide();
    }

    $(function () {
        var austDay = new Date();
        austDay = new Date(2013, 03, 05);
        var minutos = parseInt($('#hdn-Minutos').val());
        var segundos = parseInt($('#hdn-Segundos').val());
        var untilStr = "+" + minutos + "m " + "+" + segundos + "s";
        var strDate = $('#hdn-FechaInicioEjecucion').val().split(',');
        var d = new Date(parseInt(strDate[0]), parseInt(strDate[1]) - 1, parseInt(strDate[2]), parseInt(strDate[3]), parseInt(strDate[4]), parseInt(strDate[5]), 0);
        var dInicio = new Date(parseInt(strDate[0]), parseInt(strDate[1]) - 1, parseInt(strDate[2]), parseInt(strDate[3]), parseInt(strDate[4]), parseInt(strDate[5]), 0);
        //d = new Date();
        d.setSeconds(d.getSeconds() + segundos);
        d.setMinutes(d.getMinutes() + minutos);
        $('#tiempoRestante').countdown({ until: d, format: 'MS', onExpiry: liftOff });

        function liftOff() {
            setTiempoTranscurrido();
            $('.btn-terminar-examen-hidden').click();
        }

        $('.btn-terminar-examen').click(function () {
            setTiempoTranscurrido();
        });

        function setTiempoTranscurrido() {
            var dActual = new Date();
            var diff = dActual - dInicio;
            var xHelper = diff / 1000;
            var numhours = Math.floor(((xHelper % 31536000) % 86400) / 3600);
            var numminutes = Math.floor((((xHelper % 31536000) % 86400) % 3600) / 60);
            var numseconds = Math.floor((((xHelper % 31536000) % 86400) % 3600) % 60);
            var strTime = numhours.toString() + ':' + numminutes.toString() + ':' + numseconds.toString();
            $("#hdn-TiempoTranscurrido").val(strTime);
        }
    });




</script>
